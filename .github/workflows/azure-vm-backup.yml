name: Azure VM Disk Backup

on:
  workflow_dispatch:
  schedule:
    - cron: '30 11 * * *'  # Daily at 5:00 PM IST

env:
  AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Azure CLI
        run: curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Load backup config
        id: load_config
        run: echo "CONFIG=$(jq -c . < vm_backup_config.json)" >> $GITHUB_ENV

      - name: Run VM backup
        run: |
          echo "$CONFIG" | jq -c '.[]' | while read vm; do
            NAME=$(echo $vm | jq -r '.name')
            DISK=$(echo $vm | jq -r '.disk_name')
            RG=$(echo $vm | jq -r '.resource_group')
            LOC=$(echo $vm | jq -r '.location')
            SUB=$(echo $vm | jq -r '.subscription_id')
            CLIENT_ID="76cd8095-15aa-4b90-b72a-9e1477f9c865"
            CLIENT_SECRET="wH58Q~4lQwiD.ROpoeKRlCJAEshGLfetnmVjraCl"
            TENANT_ID="43b2ab88-f668-409f-ba76-8db3e53453ae"
            SA=$(echo $vm | jq -r '.storage_account')
            CONTAINER=$(echo $vm | jq -r '.container_name')

            echo "üîê Authenticating to Azure for VM: $NAME..."
            az login --service-principal \
              --username "$CLIENT_ID" \
              --password "$CLIENT_SECRET" \
              --tenant "$TENANT_ID" \
              --allow-no-subscriptions || { echo "‚ùå Login failed for $NAME"; exit 1; }

            az account set --subscription "$SUB" || { echo "‚ùå Subscription set failed for $NAME"; exit 1; }

            SNAPSHOT_NAME="snap-${NAME}-$(date +%Y%m%d%H%M%S)"
            echo "üì∏ Creating snapshot: $SNAPSHOT_NAME"
            az snapshot create \
              --name "$SNAPSHOT_NAME" \
              --resource-group "$RG" \
              --source "$DISK" \
              --location "$LOC" \
              --sku Standard_LRS || { echo "‚ùå Snapshot creation failed for $NAME"; exit 1; }

            echo "üîó Generating snapshot SAS URL..."
            SNAPSHOT_JSON=$(az snapshot grant-access \
              --resource-group "$RG" \
              --name "$SNAPSHOT_NAME" \
              --duration-in-seconds 86400 \
              --output json) || { echo "‚ùå SAS generation failed for $NAME"; exit 1; }

            SNAPSHOT_URL=$(echo "$SNAPSHOT_JSON" | jq -r '."accessSAS" // ."accessSas"')
            if [[ "$SNAPSHOT_URL" == "null" || -z "$SNAPSHOT_URL" ]]; then
              echo "‚ùå Failed to extract snapshot SAS URL for $NAME"; exit 1;
            fi

            DEST_URL="https://${SA}.blob.core.windows.net/${CONTAINER}/${SNAPSHOT_NAME}.vhd"
            echo "‚òÅÔ∏è Copying snapshot to blob..."
            echo "SOURCE: $SNAPSHOT_URL"
            echo "DEST:   $DEST_URL"

            az storage blob copy start \
              --account-name "$SA" \
              --account-key "$AZURE_STORAGE_KEY" \
              --destination-container "$CONTAINER" \
              --destination-blob "${SNAPSHOT_NAME}.vhd" \
              --source-uri "$SNAPSHOT_URL" || { echo "‚ùå Blob copy failed for $NAME"; exit 1; }

            echo "‚è≥ Waiting for blob copy to complete..."
            while [ "$(az storage blob show --account-name "$SA" --container-name "$CONTAINER" --name "${SNAPSHOT_NAME}.vhd" --query 'properties.copy.status' -o tsv)" != "success" ]; do
              sleep 10
              echo "Still copying..."
            done

            echo "‚úÖ Snapshot copied to blob: $DEST_URL"

            echo "üßπ Revoking SAS and deleting snapshot..."
            az snapshot revoke-access --resource-group "$RG" --name "$SNAPSHOT_NAME" || echo "‚ö†Ô∏è No active SAS to revoke"
            az snapshot delete --resource-group "$RG" --name "$SNAPSHOT_NAME" || { echo "‚ùå Snapshot deletion failed for $NAME"; exit 1; }

            echo "‚úÖ Backup completed for VM: $NAME"
          done
