#!/bin/bash

# Load your JSON config
CONFIG='[
  {
    "vmName": "Test-BackupVM",
    "resourceGroup": "Backup-Automation",
    "diskName": "Test-BackupVM_OsDisk_1_522b9b43a633431b8d99ff4a7ae7bb49",
    "location": "centralindia"
  }
]'

# Service Principal Credentials
CLIENT_ID="your-client-id"
CLIENT_SECRET="your-client-secret"
TENANT_ID="your-tenant-id"
SUBSCRIPTION_ID="your-subscription-id"

# Blob Storage destination (must already exist)
DESTINATION_URL_BASE="https://diskstorageautobackup.blob.core.windows.net/vhdsnapshots"

# Log in using Service Principal
echo "üîê Authenticating to Azure..."
az logout
az login --service-principal -u "$CLIENT_ID" -p "$CLIENT_SECRET" --tenant "$TENANT_ID" > /dev/null

az account set --subscription "$SUBSCRIPTION_ID"

# Start backup process
echo "$CONFIG" | jq -c '.[]' | while read vm; do
  NAME=$(echo "$vm" | jq -r '.vmName')
  RG=$(echo "$vm" | jq -r '.resourceGroup')
  DISK_NAME=$(echo "$vm" | jq -r '.diskName')
  LOCATION=$(echo "$vm" | jq -r '.location')

  TIMESTAMP=$(date +%Y%m%d%H%M%S)
  SNAPSHOT_NAME="snap-$NAME-$TIMESTAMP"

  echo "üì∏ Creating snapshot: $SNAPSHOT_NAME"

  az snapshot create \
    --resource-group "$RG" \
    --name "$SNAPSHOT_NAME" \
    --source "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RG/providers/Microsoft.Compute/disks/$DISK_NAME" \
    --location "$LOCATION" \
    --output none

  # Wait for snapshot to become available
  echo "‚è≥ Waiting for snapshot to be ready..."
  for i in {1..5}; do
    STATE=$(az snapshot show --name "$SNAPSHOT_NAME" --resource-group "$RG" --query "provisioningState" -o tsv)
    echo "   ‚ûú Snapshot state: $STATE"
    [ "$STATE" = "Succeeded" ] && break
    sleep 10
  done

  if [ "$STATE" != "Succeeded" ]; then
    echo "‚ùå Snapshot $SNAPSHOT_NAME failed to become ready. Skipping..."
    continue
  fi

  echo "üîó Generating SAS URL..."
  SNAPSHOT_URL=$(az snapshot grant-access \
    --resource-group "$RG" \
    --name "$SNAPSHOT_NAME" \
    --duration-in-seconds 3600 \
    --query 'accessSas' -o tsv)

  if [ -z "$SNAPSHOT_URL" ]; then
    echo "‚ùå Failed to generate SAS URL for snapshot $SNAPSHOT_NAME"
    continue
  fi

  DEST_FILE="$DESTINATION_URL_BASE/$SNAPSHOT_NAME.vhd"

  echo "üì§ Copying snapshot to Blob Storage..."
  azcopy copy "$SNAPSHOT_URL" "$DEST_FILE" --overwrite=true

  if [ $? -ne 0 ]; then
    echo "‚ùå AzCopy failed for $NAME"
    continue
  fi

  echo "‚úÖ Snapshot of $NAME backed up successfully to $DEST_FILE"

done
